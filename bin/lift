#!/usr/bin/env lua

--collectgarbage('stop') -- disable GC by default

local cli = require 'lift.cli'
local task = require 'lift.task'
local config = require 'lift.config'
local loader = require 'lift.loader'
local diagnostics = require 'lift.diagnostics'

os.exit(diagnostics.wrap(function()

  -- parse key=value configs at the beginning of arg list
  local cli_scope = config:new_parent('cli')
  cli.parse_config(arg)

  -- run init scripts
  local top_scope = loader.init()

  -- add files specific to the 'lift' executable to the ${load_path}
  config:insert_unique('load_path', config.LIFT_SRC_DIR..'/files/lift')

  -- make cli configs override init configs
  assert(top_scope:get_parent() == cli_scope)
  top_scope:set_parent(cli_scope:get_parent())
  cli_scope:set_parent(config:get_parent())
  config:set_parent(cli_scope)

  -- run CLI scripts
  local app = cli.new()
  loader.load_all('cli', nil, app)

  -- default command is an alias for the 'run' command
  app:delegate_to(app:get_command('task run'))

  app:command 'list' :delegate_to(app:get_command 'task list')
    :desc('list [pattern]', 'Show list of tasks (that match a pattern)')

  -- process CLI
  app:process(arg)

end))
